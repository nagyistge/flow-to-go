<!-- Storage-Node -->

<script type="text/x-red" data-template-name="storage">

  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label for="node-input-database"><i class="fa fa-database"></i> Database</label>
    <input type="storage-file" id="node-input-database">
  </div>

  <div class="form-row">
    <label for="node-input-method"><i class="fa fa-cogs"></i> Method</label>
    <select type="text" id="node-input-method" placeholder="select method">
      <option value="insert">insert documents</option>
      <option value="update">update documents</option>
      <option value="find">find documents</option>
      <option value="count">count documents</option>
      <option value="remove">remove documents</option>
    </select>
  </div>

  <div id="query-row" class="form-row">
    <label for="node-input-query"><i class="fa fa-filter"></i> Query</label>
    <input type="text" id="node-input-query" placeholder="leave blank if set in flow">
  </div>

  <div id="filter-group">
    <div class="form-row">
      <label for="node-input-skip"><i class="fa fa-filter"></i> Skip</label>
      <input type="text" id="node-input-skip" placeholder="skip results">
    </div>

    <div class="form-row">
      <label for="node-input-limit"><i class="fa fa-filter"></i> Limit</label>
      <input type="text" id="node-input-limit" placeholder="limit results">
    </div>
  </div>

  <div id="sort-row" class="form-row">
    <label for="node-input-sort"><i class="fa fa-sort-amount-desc"></i> Sort</label>
    <input type="text" id="node-input-sort" placeholder="sort results">
  </div>

  <div id="update-group">
    <div class="form-row">
      <label for="node-input-update"><i class="fa fa-pencil-square-o"></i> Update</label>
      <input type="text" id="node-input-update" placeholder="update statement">
    </div>

    <div class="form-row">
      <label for="node-input-options"><i class="fa fa-pencil-square-o"></i> Options</label>
      <input type="text" id="node-input-options" placeholder="update options">
    </div>
  </div>

  <div class="form-tips"><b>See:</b>
    <ul>
      <li><a href="https://github.com/louischatriot/nedb/wiki/Inserting-documents"> insert documents</a></br>
      Stores the message-payload as document. If the payload contains an array each entry is treated as single document.
      </li>
      <li><a href="https://github.com/louischatriot/nedb/wiki/Finding-documents#finding-documents">find documents</a></li>
      <li><a href="https://github.com/louischatriot/nedb/wiki/Finding-documents#sorting-and-paginating">sorting and pagination</a></li>
    </ul>
  </div>
</script>

<script type="text/x-red" data-help-name="storage">
  <p></p>
</script>

<script type="text/javascript">
  RED.nodes.registerType('storage', {
    category: 'custom',
    defaults: {
      name: { value: ''},
      database: { value:'', type:'storage-file', required: true },
      method: { value:'insert', required:true },
      query: { value:''},
      limit: { value:'', validate:RED.validators.regex(/^$|\d+/), required: false },
      skip: { value:'', validate:RED.validators.regex(/^$|\d+/), required: false },
      sort: { value:''},
      update: { value: ''},
      options: { value: ''},
    },
    inputs:1,
    outputs:1,
    color: "#3FADB5",
    icon: 'db.png',
    align: 'right',
    paletteLabel: 'storage',
    label: function() {
      return this.name || `storage (${this.method})`
    },
    labelStyle: function() {
      return this.database ? '' : 'node_label_italic'
    },
    oneditprepare: function() {
      $("#node-input-method").change(function(){
        const queryRow = $("#query-row");
        const sortRow = $("#sort-row");
        const filterGroup = $("#filter-group");
        const updateGroup = $("#update-group");

        switch ($(this).val()) {
          case 'remove':
            queryRow.show();
            filterGroup.hide();
            updateGroup.hide();
            sortRow.hide();
            break;
          case 'update':
            queryRow.show();
            filterGroup.hide();
            updateGroup.show();
            sortRow.hide();
            break;
          case 'find':
            queryRow.show();
            filterGroup.show();
            updateGroup.hide();
            sortRow.show();
            break;
          case 'count':
            queryRow.show();
            filterGroup.show();
            updateGroup.hide();
            sortRow.hide();
            break;
          case 'insert':
          default:
            queryRow.hide();
            filterGroup.hide();
            updateGroup.hide();
            sortRow.hide();
            break;
        }
      });
    }
  })
</script>

<!-- Configuration-Node -->

<script type="text/x-red" data-template-name="storage-file">
  
  <div class="form-row">
    <label for="node-config-input-filename"><i class="fa fa-database"></i> File</label>
    <input type="text" id="node-config-input-filename" placeholder="database.db / blank for in-memory">
  </div>

</script>

<script type="text/javascript">
  RED.nodes.registerType('storage-file',{
    category: 'config',
    defaults: {
      filename: {
        value: '', 
        required: false,
        validate: RED.validators.regex(/^$|\w+.db/) },
    },
    label: function() {
      return this.filename || 'in-memory';
    }
  });
</script>